###
# This is a text guide for the HOL-0518-01  field enablement dmeocenter lab
# Thanks to Russ Stevenson for the original
# Do Not just run this as a script, be sure you know what you are doing.  
# The intention is for edification, and we all can use as much of that as we can get! 
#
# Original 	2020-02 - Russ
# Updated 	20210216 KMac
#
###

#Lab Overview:
#Add smartconnect advanced license
#Assign a SmartConnect Service IP to the subnet0
#Create an IP Pool, assign interfaces and smartconnect service name to the pool1
#Review the networking 
#Create the required DNS records for SmartConnect
#Test SmartConnect
#Join the Cluster to Active Directory
#Assign the Active Directory Provider to the System Access Zone
#Review the Access Zone


isi license add --evaluation=SMARTCONNECT_ADVANCED
	###hit space, until end of eula, hit q and yes to accept eula

isi license list

###setup SmartConnect on Isilon

isi network subnets modify groupnet0.subnet0 --sc-service-addr=192.168.1.100 --sc-service-name=ssip-isilon.demo.local
isi network pools create --id=groupnet0:subnet0:pool1 --ranges=192.168.1.60-192.168.1.80  --access-zone=System  --alloc-method=dynamic  --ifaces=1-3:ext-1 --sc-subnet=subnet0  --sc-dns-zone=hol518.demo.local    --description=hol518_pool
isi network subnets list
isi network subnets view groupnet0.subnet0
isi network pools list
isi network pools view groupnet0:subnet0:pool1

# Review these settings from the webUI
# username: root
# password: <In lab setup docs in HOL>


###Create the DNS records for SmartConnect
###Go to windows DNS admin console, found in the toolbar on the democenter host

## -go to the demo.local zone
## -Add A record ssip-isilon  192.168.1.100
## -Add NS record hol518    --> ssip-isilon.demo.local
## -Test SCzone:
## nslookup hol518.demo.local 192.168.1.2
## 

# OR (either way make sure you understand smartconnect)
###Run the following PowerShell command:

Add-DnsServerZoneDelegation -Name "demo.local" -ChildZoneName "hol518" -NameServer "ssip-isilon.demo.local" -IPAddress 192.168.1.100

# -Test SCzone:
nslookup hol518.demo.local 192.168.1.2


###join the Isilon Cluster to Active Directory, this lab has a preconfigured Active Domain - DEMO.LOCAL, the admins tools are on the toolbar on the democenter host 
#	isi auth ads create demo.local administrator --password=<FROM ABOVE>
#	isi auth ads list
#	isi zone zones modify System --add-auth-providers=lsa-activedirectory-provider:DEMO.LOCAL
#	isi zone zones list -v
	
	# Review these settings from the webUI
		
	###Review the Isilon Computer Object in Add
	From the Domain Controller, select Users and Computer and find the Isilon cluster in Computers
		
	###on isilon make our base hol518 directory
	
	mkdir -p /ifs/hol518
	chmod 777 /ifs/hol518
	touch /ifs/hol518/this_is_isilon.txt
	chmod 777 /ifs/hol518/this_is_isilon.txt
	cd /ifs/hol518
	ls -al 
	ls -le this_is_isilon.txt
	ls -len this_is_isilon.txt
	
	echo 'Have fun!'

###
# Auditing specific lab setup starts here
###

# First, lets create a specific audited AZ
 isi zone zones create --name=auditedzone --path=/ifs/auditedzone --create-path --auth-providers=ads:DEMO.LOCAL
 
 isi network pools create --id=groupnet0.subnet0.auditedpool --ranges=192.168.1.160-192.168.1.180 --access-zone=auditedzone \ 
 	--alloc-method=dynamic --ifaces=1-3:ext-1 --sc-subnet=subnet0 --sc-dns-zone=topsecret.demo.local --description='Audited AZ Pool'

 # Validate with:  
 isi network pools view groupnet0.subnet0.auditedpool 
 
# Be sure to go configure the topsecret delegation in AD DNS, similar to above

 ###
 # Enable protocol auditing
 ###
 isi audit settings global modify --protocol-auditing-enabled=yes --audited-zones=auditedzone 
 
 # Validate with:  
 isi audit settings global view
 
 # Enable just the specific events needed, note any read type event may have heavy performance penalty associated with itt. 
 
 isi audit settings modify --zone=auditedzone \
 --audit-success='create_file,close_file_modified,delete_file,delete_directory,rename_file,rename_directory,set_security_file,set_security_directory' \
 --audit-failure='create_file,close_file_modified,delete_file,delete_directory,rename_file,rename_directory,set_security_file,set_security_directory' \
 --clear-syslog-audit-events --syslog-forwarding-enabled=no
 
 # Validate with:  
 isi audit settings view --zone=auditedzone

 # Create an SMB share for testing in the auditedzone
 isi smb shares create --zone=auditedzone --path=/ifs/auditedzone/supersecrets --name=supersecrets --description='Super Top Secret Documents' \ 
 --auto-create-directory=yes --browsable=no --continuously-available=yes 
 
 # Allow wide open share level access, not recommended for a production usecase
 isi smb shares permission modify --zone=auditedzone supersecrets --wellknown=Everyone --permission-type=allow --permission=full 
 
 # Lets set the owner to jwick
 chown -s 'DEMO\jwick' /ifs/auditedzone/supersecrets
 chmod +a user 'DEMO\jwick' allow generic_all /ifs/auditedzone/supersecrets
 
 ###
 # Use the CLI utility isi_audit_viewer to demonstrate the audit events being created
 #  Remember that it is node specific, so use the -n option to specify which node you are connecting to
 ###
 isi_audit_viewer -t protocol -v  -n 1
 
 ###
 # Use Windows Explorer on the Lab Desktop to access the share with the UNC path: \\topsecret.demo.lab\supersecrets
 # You can map a drive as the demo user "DEMO\jwick" or whomeveer you'd like
 ###
 In Windows Explorer, create a folder, create a new text document, copy some existing files over, delete a few files, change security, etc
 
 ###
 # Use the CLI utility isi_audit_viewer again to show the new events.  Remember to select the node you connected to
 ###
 isi_audit_viewer -t protocol -v  -n 1
 
 
 Example Output below: 
 
 Cluster01-3: [14: Tue Feb 16 14:15:10 2021] {"id":"6f38eb57-70a4-11eb-b6d0-005056013158","timestamp":1613513710788099,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"rename","detailType":"rename-directory","isDirectory":true,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\New folder","newFileName":"\\ifs\\auditedzone\\supersecrets\\Hello World","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"ntStatus":0,"fsId":1,"partialPath":"New folder","rootInode":4313318641,"inode":4312728519}}
Cluster01-3: [15: Tue Feb 16 14:15:36 2021] {"id":"7e4d2bec-70a4-11eb-b6d0-005056013158","timestamp":1613513736086637,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\Hands On Lab Connections.backup","ntStatus":0,"fsId":1,"partialPath":"Hands On Lab Connections.backup","rootInode":4313318641,"inode":4312269108}}
Cluster01-3: [16: Tue Feb 16 14:15:36 2021] {"id":"7e6057b0-70a4-11eb-b6d0-005056013158","timestamp":1613513736212288,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\Hands On Lab Connections.backup","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":19382,"numberOfReads":0,"numberOfWrites":1,"ntStatus":0,"fsId":1,"partialPath":"Hands On Lab Connections.backup","rootInode":4313318641,"inode":4312269108}}
Cluster01-3: [17: Tue Feb 16 14:15:36 2021] {"id":"7e63d950-70a4-11eb-b6d0-005056013158","timestamp":1613513736235252,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\Hands On Lab Connections.rtsz","ntStatus":0,"fsId":1,"partialPath":"Hands On Lab Connections.rtsz","rootInode":4313318641,"inode":4312269109}}
Cluster01-3: [18: Tue Feb 16 14:15:36 2021] {"id":"7e6bdb26-70a4-11eb-b6d0-005056013158","timestamp":1613513736287746,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\Hands On Lab Connections.rtsz","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":19319,"numberOfReads":0,"numberOfWrites":1,"ntStatus":0,"fsId":1,"partialPath":"Hands On Lab Connections.rtsz","rootInode":4313318641,"inode":4312269109}}
Cluster01-3: [19: Tue Feb 16 14:15:49 2021] {"id":"862f1fec-70a4-11eb-b6d0-005056013158","timestamp":1613513749311493,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","ntStatus":0,"fsId":1,"partialPath":"splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","rootInode":4313318641,"inode":4312269110}}
Cluster01-3: [20: Tue Feb 16 14:16:13 2021] {"id":"94b1d5a1-70a4-11eb-b6d0-005056013158","timestamp":1613513773656217,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":384238233,"numberOfReads":0,"numberOfWrites":367,"ntStatus":0,"fsId":1,"partialPath":"splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","rootInode":4313318641,"inode":4312269110}}
Cluster01-3: [21: Tue Feb 16 14:16:13 2021] {"id":"94b9c167-70a4-11eb-b6d0-005056013158","timestamp":1613513773708127,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\eventgen.conf","ntStatus":0,"fsId":1,"partialPath":"eventgen.conf","rootInode":4313318641,"inode":4312728521}}
Cluster01-3: [22: Tue Feb 16 14:16:13 2021] {"id":"94c149eb-70a4-11eb-b6d0-005056013158","timestamp":1613513773757497,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\eventgen.conf","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":985,"numberOfReads":0,"numberOfWrites":1,"ntStatus":0,"fsId":1,"partialPath":"eventgen.conf","rootInode":4313318641,"inode":4312728521}}
Cluster01-3: [23: Tue Feb 16 14:16:13 2021] {"id":"94c664e8-70a4-11eb-b6d0-005056013158","timestamp":1613513773790956,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\eventgen_640.tgz","ntStatus":0,"fsId":1,"partialPath":"eventgen_640.tgz","rootInode":4313318641,"inode":4312334595}}
Cluster01-3: [24: Tue Feb 16 14:16:14 2021] {"id":"9538b6cf-70a4-11eb-b6d0-005056013158","timestamp":1613513774540217,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\eventgen_640.tgz","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":4819419,"numberOfReads":0,"numberOfWrites":10,"ntStatus":0,"fsId":1,"partialPath":"eventgen_640.tgz","rootInode":4313318641,"inode":4312334595}}
Cluster01-3: [25: Tue Feb 16 14:16:14 2021] {"id":"953cf60f-70a4-11eb-b6d0-005056013158","timestamp":1613513774567998,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\sample.tutorial1","ntStatus":0,"fsId":1,"partialPath":"sample.tutorial1","rootInode":4313318641,"inode":4312728522}}
Cluster01-3: [26: Tue Feb 16 14:16:14 2021] {"id":"956403ff-70a4-11eb-b6d0-005056013158","timestamp":1613513774823944,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\sample.tutorial1","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":533417,"numberOfReads":0,"numberOfWrites":3,"ntStatus":0,"fsId":1,"partialPath":"sample.tutorial1","rootInode":4313318641,"inode":4312728522}}
Cluster01-3: [27: Tue Feb 16 14:16:14 2021] {"id":"95675c94-70a4-11eb-b6d0-005056013158","timestamp":1613513774845872,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"CREATED","isDirectory":false,"desiredAccess":1507743,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"fileName":"\\ifs\\auditedzone\\supersecrets\\Splunk_Template.txt","ntStatus":0,"fsId":1,"partialPath":"Splunk_Template.txt","rootInode":4313318641,"inode":4312924725}}
Cluster01-3: [28: Tue Feb 16 14:16:14 2021] {"id":"95707177-70a4-11eb-b6d0-005056013158","timestamp":1613513774905388,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"close","detailType":"close-file-modified","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\Splunk_Template.txt","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"bytesRead":0,"bytesWritten":1779,"numberOfReads":0,"numberOfWrites":1,"ntStatus":0,"fsId":1,"partialPath":"Splunk_Template.txt","rootInode":4313318641,"inode":4312924725}}
Cluster01-3: [29: Tue Feb 16 14:17:00 2021] {"id":"b0e7fe36-70a4-11eb-b6d0-005056013158","timestamp":1613513820987355,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"delete","detailType":"delete-file","isDirectory":false,"clientIPAddr":"192.168.1.2","fileName":"\\ifs\\auditedzone\\supersecrets\\splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","userSID":"S-1-5-21-2835929079-83856256-991020882-15105","userID":1000002,"ntStatus":0,"fsId":1,"partialPath":"splunk-7.3.0-657388c7a488-linux-2.6-x86_64.rpm","rootInode":4313318641,"inode":4312269110}}
Cluster01-2: [4: Tue Feb 16 12:18:56 2021] {"id":"3238bd03-7094-11eb-956f-00505601315b","timestamp":1613506736498208,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"DOES_NOT_EXIST","isDirectory":false,"desiredAccess":1442207,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-500","userID":1000000,"fileName":"\\ifs\\auditedzone\\supersecrets\\New Text Document.txt","ntStatus":3221225506,"fsId":1,"partialPath":"New Text Document.txt","rootInode":4313318641}}
Cluster01-2: [5: Tue Feb 16 12:18:56 2021] {"id":"3239336f-7094-11eb-956f-00505601315b","timestamp":1613506736501238,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"DOES_NOT_EXIST","isDirectory":false,"desiredAccess":1442207,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-500","userID":1000000,"fileName":"\\ifs\\auditedzone\\supersecrets\\New Text Document.txt","ntStatus":3221225506,"fsId":1,"partialPath":"New Text Document.txt","rootInode":4313318641}}
Cluster01-2: [6: Tue Feb 16 12:18:56 2021] {"id":"32397be8-7094-11eb-956f-00505601315b","timestamp":1613506736503092,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"DOES_NOT_EXIST","isDirectory":false,"desiredAccess":1180063,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-500","userID":1000000,"fileName":"\\ifs\\auditedzone\\supersecrets\\New Text Document.txt","ntStatus":3221225506,"fsId":1,"partialPath":"New Text Document.txt","rootInode":4313318641}}
Cluster01-2: [7: Tue Feb 16 12:18:56 2021] {"id":"3239dfb5-7094-11eb-956f-00505601315b","timestamp":1613506736505647,"payloadType":"c411a642-c139-4c7a-be58-93680bc20b41","payload":{"protocol":"SMB2","zoneID":2,"zoneName":"auditedzone","eventType":"create","detailType":"create-file","createResult":"DOES_NOT_EXIST","isDirectory":false,"desiredAccess":1180054,"clientIPAddr":"192.168.1.2","createDispo":2,"userSID":"S-1-5-21-2835929079-83856256-991020882-500","userID":1000000,"fileName":"\\ifs\\auditedzone\\supersecrets\\New Text Document.txt","ntStatus":3221225506,"fsId":1,"partialPath":"New Text Document.txt","rootInode":4313318641}}





	
